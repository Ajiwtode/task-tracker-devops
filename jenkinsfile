pipeline {
  agent any

  environment {
    IMAGE_NAME = "localhost:8085/task-app"
    IMAGE_TAG  = "1.0.${BUILD_NUMBER}"
    DOCKER_CREDS = credentials('nexus-creds')
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Docker Build') {
      steps {
        sh '''
          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
        '''
      }
    }

    stage('Docker Login') {
      steps {
        sh '''
          echo $DOCKER_CREDS_PSW | docker login localhost:8085 \
          -u $DOCKER_CREDS_USR --password-stdin
        '''
      }
    }

    stage('Push to Nexus') {
      steps {
        sh '''
          docker push $IMAGE_NAME:$IMAGE_TAG
          docker push $IMAGE_NAME:latest
        '''
      }
    }
  }

  post {
    success {
      echo "✅ Image pushed to Nexus successfully"
    }
    failure {
      echo "❌ Pipeline failed"
    }
  }
}

